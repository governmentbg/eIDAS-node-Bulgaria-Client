# Функционални изисквания

<a name="authentication response"></a>
## Общи проверки при отговор от автентикация

| ID | Описание | Твърдение |
|:----:|:--------------|:-----|
| AV-1 | Проверка на задължителни параметри | Наличието на всички задължителни параметри е задължително спрямо [**API описанието**](Service-API_BG.md#returnUrl). В противен случай, **400 Bad Request** грешка ще бъде върната.|
| AV-2 | Проверка за позволените стойности във всички параметри | Стойността на всички параметри трябва да бъде проверена спрямо ограниченията описани в [**API описанието**](Service-API_BG.md#returnUrl). В противен случай, **400 Bad Request** грешка ще бъде върната.|
| AV-3 | Проверка на XML схема от SAML отговора | Преди всякакви проверки на съдържанието, SAMLResponse съдържанието трябва да бъде проверено спрямо SAML2 основната и eIDAS XML схемите. Ако SAMLResponse не отговаря на схемата, **400 Bad Request** грешкаще бъде върната. По подробно описание има в [**API описанието**](Service-API_BG.md#error handling).|
| AV-4 | SAML отговорът винаги е подписан | Идващия SAML отговор трябва винаги да бъде подписан. Ако не е, **400 Bad Request** грешка ще бъде върната. |
| AV-5 | Валидаиця на подписа от SAML отговора  | Подписа на идващия SAML отговор трябва да бъде валидиран използвайки сертификата за подписване, предоставен в метаданните на Specific-Connector (не сертификата в отговора). Ако подписа не е валиден, ще се върне грешка **400 Bad Request**. |
| AV-6 | Проверка статуса на SAML отговора | Последваща обработка на SAML съобщението трябва да бъде прекратена, ако първичния отговор не е **urn:oasis:names:tc:SAML:2.0:status:Success**. <p>Грешка **401 Unauthorized** ще бъде върната към потребителя ако статусите от второ ниво са <ul><li>**urn:oasis:names:tc:SAML:2.0:status:AuthnFailed** (authentication failed)</li><li>**urn:oasis:names:tc:SAML:2.0: status:RequestDenied** (user did not consent to disclosure of personal information)</li></ul></p><p>За всички останали се връща **HTTP 500 Internal Server Error** и statusCode и statusMessage се записват в журнала на ниво Error. </p> |
| AV-7 | Контрол на SAML отговора по време | SAML отговора създаден на (`/saml2p:Response/@IssueInstant`) трябва да бъде изтекъл или в бъдещето. Времето трябва да е между `/saml2p:Response/@IssueInstant` - позволен интервал - позволена разлика в системното време и `/saml2p:Response/@IssueInstant` + позволен интервал + позволена разлика в системното време. В противен случай, грешката която се изпраща е **400 Bad Request**. |
| AV-8 | Проверка на валидна заявка, асоцирана с SAML отговора | Съдържанието на `InResponseTo` от идващия SAML отговортрябва да се отнася до валидна, сорова заявка в таблицата за изпратени заявки. В противен случай, грешка **400 Bad Request** ще бъде върната. |
| AV-9 | Елемента `Assertion` при успешна автентикация трябва да е криптиран | Съдържанието на идващия верифициран SAML отговор трябва да съдържа точно един криптиран `Assertion` елемент (във формата на `EncryptedAssertion`) **400 Bad Request**. |
| AV-10 | `Assertion` няма специфични рестрикции | Декриптираната част на успешен отговор от автентикация, трябва да съдържа точно една инстанция на `<saml2:Assertion>`, `<saml2:AuthnStatement>`, `<saml2:AttributeStatement>`, `<saml2:Subject>` и `<saml2:AuthnContext>`. В противен случай се изпраща грешка **400 Bad Request**. |
| AV-11 | SAML `Assertion` при успешна автентикация трябва да е подписан | За успешна автентикация, SAML `Assertion` трябва да е подписан. Ако липсва подпис, се връща грешка **400 Bad Request**. |
| AV-12 | SAML `Assertion` при провалена автентикация може да е подписан | При провалена автентикация, SAML `Assertion` може (но не е задължително) да бъде подписан.
| AV-13 | SAML `Assertion` провекра на времето | Времето на издаване на резултата (`saml2:Assertion/@IssueInstant`) трябва да не е в бъдещето или изтекло, взимайки в предвид допустимата разлика в системното време и максималното позволено. То трябва да попада между `saml2:Assertion/@IssueInstant` - позволен интервал - позволена времева разлика и `saml2:Assertion/@IssueInstant` + позволен интервал + позволена времева разлика. В противен случай, се връща грешка **400 Bad Request**. |
| AV-14 | SAML `Assertion` проверка на подписа | Ако `Assertion` елемента в SAML отговора е подписа, неговата валидност трябва да бъде проверена, посредством публичния ключ публикуван в метаданните на Specific-Connector (KeyDescriptor/@use=signing). Ако не е успешна валидацията, грешка **400 Bad Request** се връща. |
| AV-15 | SAML `Assertion/Issuer` провекра | Атрибута `saml2:Assertion/Issuer/@Format` трябва винаги да бъде `urn:oasis:names:tc:SAML:2.0:nameid-format:entity`  и съдържанието на елемента трябва да съвпада с url адреса публикуван в метаданните на Specific-Connector. Ако отговора не отговаря на това изискване, грешка **400 Bad Request** се връща.|
| AV-16 | SAML `Assertion/Subject` проверка на позволени имена | SAML отговора трябва винаги да съдържа точно един `saml2:Assertion/saml2:Subject/saml2:NameID` елемент и формата трябва да бъде един от следните: `urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified`, ` urn:oasis:names:tc:SAML:2.0:nameid-format:transient` or `urn:oasis:names:tc:SAML:2.0:nameid-format:persistent`. Ако това условие не е изпълнено се връща грешка **400 Bad Request**.</p>|
| AV-17 | SAML `Assertion/Subject` проверка на позволени методи | SAML отговорът трябва винаги да съдържа точно един `saml2:Assertion/saml2:Subject/saml2:SubjectConfirmation` елемент, кат само `urn:oasis:names:tc:SAML:2.0:cm:bearer` метода е поддържан за `@Method` атрибут. Ако не е изпъленно изискването, грешка **400 Bad Request** се връща.</p>|
| AV-18 | SAML `Assertion/Subject` проверка за изтичане | Стойността на `/saml2p:Response/saml2:Assertion/saml2:Subject/saml2:SubjectConfirmation/saml2:SubjectConfirmationData/@NotOnOrAfter` трябва да е по голяма от текущото време + позволената времева разлика + максималното време за отговор. В противен случай, **400 Bad Request** грешка се връща. |
| AV-19 | SAML `Assertion/Subject` проверка на получателя | Стойността на `/saml2p:Response/saml2:Assertion/saml2:Subject/saml2:SubjectConfirmation/saml2:SubjectConfirmationData/@Recipient` трябва да е същата, като точката в която се получава описана в конфигурацията. В противен случай, грешка **400 Bad Request** се връща. |
| AV-20 | SAML `Assertion/Subject` проверка на InResponseTo | `/saml2p:Response/saml2:Assertion/saml2:Subject/saml2:SubjectConfirmation/saml2:SubjectConfirmationData/@InResponseTo` трябва да съдържа информация за изпратената заявка в таблицта за изпратени заявки. В противен случай грешка **400 Bad Request** се връща. |
| AV-21 | Ограничение, поддържнаи от SAML `Assertion/Conditions` | <p>SAML отговора трябва винаги да съдържа точно един `saml2:Assertion/saml2:Conditions` елемент, и само `AudienceRestriction` трябва да бъде поддържан като под елемент. В противен случай се връща грешка **400 Bad Request**. |
| AV-22 | SAML `Assertion/Conditions` проверка на валидност | Стойността на `NotBefore` и `NotOnOrAfter` атрибутите от `saml2:Assertion/saml2:Conditions` елемента в SAML отговора трябва да бъде проверен. Текущото време не може да е по ранно от стойността на `NotBefore` и по късно от стойността на `NotOnOrAfter`. Ако не отговаря, грешка **400 Bad Request** се връща.</p>|
| AV-23 | Обработване на SAML `Assertion/Conditions` ограниченията | `saml2:Assertion/saml2:Conditions/saml2:AudienceRestriction` в SAML отговора трябва да съдържа поне един Audience запис. Необходимо е да има пое един Audience елемент, който да съдържа адреса на метаданните на клиента. Ако не е изпълнено условието, се връща грешка **400 Bad Request**. |
| AV-24 | SAML `Assertion` `AuthnStatement` проверка | <p>SAML отговорът трябва винаги да съдържа точно един `/saml2:Assertion/saml2:AuthnStatement` елемент, като при успешма автентикация, трябва да съдържа AuthnContext/AuthnContextClassRef елемент чието съдържание да отговаря на LoA равна или по-висока от LoA в оригиналното запитване. Ако не е изпълнено се връща грешка **400 Bad Request**.|
| AV-25 | SAML `Assertion` `AuthnStatement` проверки - `AuthnInstant` проверка на влидността| Стойността на `/saml2:Assertion/saml2:AuthnStatement/@AuthnInstant` трябва да не е изтекла (позволена разлика и време за изчакване) или да бъде в бъдещето. Ако условието не е изпълнено се връща грешка **400 Bad Request**.|
| AV-26 | Непознати грешки | Всички грешки, които не са описани в изискванията трябва да бъдат хващани. Отговорът в този случай е **500 Internal Server Error**. |
| AV-27 | Наличие на задължителните атрибути в отговора | SAML отговора тряба да съдържа всички задължителни атрибути описани в заявката. При липса се връща грешка **400 Bad Request**. |
| AV-29 | Успешна автентикация | При преминаване на всички проверки и отговор за успешна автентикация, JSON отгоовр се зъдаваспрямо описанието на [**API**](Service-API_BG.md#returnUrl). |